# Rednote Research Agent æç¤ºè¯ä¸æ¶æ„ä¼˜åŒ–åˆ†ææŠ¥å‘Š

> **åˆ†æå¯¹è±¡**: `rednote_research/prompts` åŠç›¸å…³ Agent å®ç°
> **åˆ†æè§†è§’**: é«˜çº§ Agent æç¤ºè¯å·¥ç¨‹å¸ˆ (Fabric Analysis)

æœ¬æŠ¥å‘Šå¯¹å½“å‰é¡¹ç›®çš„æç¤ºè¯ä½“ç³»è¿›è¡Œæ·±åº¦æ‹†è§£ï¼Œå¹¶ç»“åˆä»£ç é€»è¾‘æå‡ºå…·ä½“çš„ä¼˜åŒ–æ–¹æ¡ˆã€‚

---

## 1. æç¤ºè¯è¯¦ç»†åˆ†æä¸ä¼˜åŒ– (Prompt Analysis & Optimization)

### 1.1 è§„åˆ’æ™ºèƒ½ä½“ (Planner Prompt)
**æ–‡ä»¶**: `rednote_research/prompts/planner.py`
**å½“å‰çŠ¶æ€**: 
- ä»»åŠ¡æ˜¯å°†ç”¨æˆ·æ„å›¾æ‹†è§£ä¸ºå…³é”®è¯å’Œç»´åº¦ã€‚
- ä¼˜ç‚¹ï¼šæœ‰æ˜ç¡®çš„å…³é”®è¯ç”Ÿæˆè§„åˆ™ï¼ˆæ ¸å¿ƒ+çº¦æŸï¼‰ã€‚
- ç¼ºç‚¹ï¼šç›´æ¥è¾“å‡º JSONï¼Œç¼ºä¹æ€ç»´é“¾ (Chain of Thought)ï¼Œå¯èƒ½å¯¼è‡´å¯¹å¤æ‚æ„å›¾çš„ç†è§£æµäºè¡¨é¢ã€‚

#### ğŸ’¡ ä¼˜åŒ–å»ºè®®: å¼•å…¥æ€ç»´é“¾ (CoT) ä¸åæ€æ§½
åœ¨ç”Ÿæˆ JSON ä¹‹å‰ï¼Œå¼ºåˆ¶æ¨¡å‹å…ˆè¿›è¡Œè‡ªç„¶è¯­è¨€çš„åˆ†æã€‚è¿™èƒ½æ˜¾è‘—æå‡ JSON å­—æ®µçš„å‡†ç¡®æ€§ã€‚

**é¢„æœŸç¤ºä¾‹ (Optimized Prompt)**:
```python
PLANNER_PROMPT_OPTIMIZED = """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç ”ç©¶è§„åˆ’ä¸“å®¶ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ·±åº¦ç†è§£ç”¨æˆ·æ„å›¾å¹¶åˆ¶å®šæœç´¢ç­–ç•¥ã€‚

## è¾“å…¥
ç”¨æˆ·ç ”ç©¶ä¸»é¢˜ï¼š{task}

## åˆ†ææ­¥éª¤ (å¿…é¡»ä¸¥æ ¼æ‰§è¡Œ)
1. **æ„å›¾è§£æ„**ï¼šåˆ†æç”¨æˆ·èƒŒåçš„çœŸå®åŠ¨é¢ï¼ˆæ˜¯æƒ³ä¹°ä¸œè¥¿ï¼Ÿæƒ³å»æ—…æ¸¸ï¼Ÿè¿˜æ˜¯æƒ³å­¦ä¹ çŸ¥è¯†ï¼Ÿï¼‰
2. **çº¦æŸæå–**ï¼šåˆ—å‡ºæ‰€æœ‰æ˜¾æ€§çº¦æŸï¼ˆå¦‚"ä¾¿å®œ"ã€"ä¸Šæµ·"ï¼‰å’Œéšæ€§çº¦æŸï¼ˆå¦‚"é€‚åˆæ–°æ‰‹"ï¼‰ã€‚
3. **ç­–ç•¥åˆ¶å®š**ï¼šæ€è€ƒç”¨ä»€ä¹ˆè¯ç»„åˆæœ€èƒ½æœå‡ºé«˜è´¨é‡å†…å®¹ã€‚

## è¾“å‡ºè¦æ±‚
è¯·è¾“å‡ºä¸¥æ ¼çš„ JSON æ ¼å¼ï¼Œ**ä¸è¦åŒ…å«** markdown ä»£ç å—æ ‡è®°ï¼š

{
  "reasoning": "åœ¨æ­¤å¤„ç®€è¿°ä½ çš„åˆ†æè¿‡ç¨‹ï¼ˆ100å­—ä»¥å†…ï¼‰...",
  "understanding": "ç”¨æˆ·æ ¸å¿ƒè¯‰æ±‚æ˜¯...",
  "dimensions": ["ç»´åº¦1", "ç»´åº¦2", "ç»´åº¦3"],
  "keywords": ["å…³é”®è¯1", "å…³é”®è¯2", ...]
}
"""
```

### 1.2 æœç´¢æ™ºèƒ½ä½“ (Searcher Prompt)
**æ–‡ä»¶**: `rednote_research/prompts/searcher.py`
**å½“å‰çŠ¶æ€**: 
- ç”¨äº `SearcherAgent.filter_relevant` ä¸­ç­›é€‰ç¬”è®°ã€‚
- ç¼ºç‚¹ï¼šç­›é€‰æ ‡å‡†è¾ƒå®½æ³›ï¼Œç¼ºä¹å…·ä½“çš„"è´Ÿæ ·æœ¬"ç¤ºä¾‹ï¼Œå®¹æ˜“æŠŠè½¯å¹¿å½“çœŸã€‚

#### ğŸ’¡ ä¼˜åŒ–å»ºè®®: å¢åŠ  Few-Shot ç¤ºä¾‹ä¸å…·ä½“åˆ¤æ®
æ˜ç¡®ä»€ä¹ˆæ˜¯"è½¯å¹¿"ï¼ˆSoft Adï¼‰ï¼Œå¹¶è¦æ±‚æ¨¡å‹è¯†åˆ«ã€‚

**é¢„æœŸç¤ºä¾‹ (Optimized Prompt)**:
```python
SEARCHER_PROMPT_OPTIMIZED = """ä½ æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„æ•°æ®ç­›é€‰ä¸“å®¶ã€‚è¯·è¯„ä¼°ä»¥ä¸‹å°çº¢ä¹¦ç¬”è®°ä¸ä¸»é¢˜çš„ç›¸å…³æ€§ã€‚

## ç­›é€‰æ ‡å‡†ï¼ˆé«˜æ ‡å‡†ï¼‰
1. **âœ… å¼ºç›¸å…³**ï¼šæ ‡é¢˜/æ‘˜è¦ç›´æ¥è§£å†³æ ¸å¿ƒé—®é¢˜ï¼Œä¸”åŒ…å«å…·ä½“ç»éªŒ/æ•°æ®ã€‚
2. **âŒ è½¯å¹¿/è¥é”€**ï¼šæ ‡é¢˜å¤¸å¼ ï¼ˆ"ç»ç»å­"ã€"ä¸è®º..."ï¼‰ã€å«æœ‰æ˜æ˜¾è´­ä¹°å¼•å¯¼ã€ç¼ºä¹å®è´¨å†…å®¹çš„ç¬”è®°ã€‚
3. **âŒ çº¯æ¬è¿**ï¼šå†…å®¹ç©ºæ³›ï¼Œæ— ä¸ªäººçœŸå®ä½“éªŒã€‚

## ç¤ºä¾‹
- ä¸»é¢˜ï¼šæ­¤æ—¶æ­¤åˆ»çš„ä¸Šæµ·å¤©æ°”
- ç¬”è®°Aï¼š"ä¸Šæµ·è¿ªå£«å°¼æ”»ç•¥ï¼è¶…å…¨ï¼" -> âŒ ä¸ç›¸å…³ï¼ˆè¿™æ˜¯æ”»ç•¥ï¼Œä¸æ˜¯å®æ—¶å¤©æ°”ï¼‰
- ç¬”è®°Bï¼š"ä»Šå¤©ä¸Šæµ·ä¸‹é›¨äº†ï¼Œå¥½å†·" -> âœ… ç›¸å…³ï¼ˆå®æ—¶ä½“éªŒï¼‰

è¯·è¿”å›æœ€ç›¸å…³çš„ç¬”è®°åºå·åˆ—è¡¨ï¼Œæ ¼å¼ï¼š1, 3, 5
"""
```

### 1.3 åˆ†ææ™ºèƒ½ä½“ (Analyzer Prompt)
**æ–‡ä»¶**: `rednote_research/prompts/analyzer.py`
**å½“å‰çŠ¶æ€**: 
- æœ€æ ¸å¿ƒçš„ Promptï¼Œè´Ÿè´£ç”Ÿæˆ Insightã€‚
- ç¼ºç‚¹ï¼šè™½ç„¶è¦æ±‚äº†æ¥æºæ ‡æ³¨ï¼Œä½†æ²¡æœ‰å¼ºåˆ¶æ•°æ®ç»“æ„å…³è”ï¼ˆCitation Enforcementï¼‰ã€‚å¯¹äº"ç—›ç‚¹"å’Œ"å‘ç°"çš„æŒ–æ˜å¯èƒ½ä¸å¤Ÿæ·±å…¥ã€‚

#### ğŸ’¡ ä¼˜åŒ–å»ºè®®: ç»“æ„åŒ–å¼•ç”¨éªŒè¯
å¼ºåˆ¶æ¨¡å‹åœ¨æå‡ºè§‚ç‚¹æ—¶åŒ…å«æ¥æº IDï¼Œä¾¿äºåç»­å‰ç«¯æ¸²æŸ“ç‚¹å‡»è·³è½¬ã€‚

**é¢„æœŸç¤ºä¾‹ (Optimized Prompt)**:
```python
ANALYZER_PROMPT_OPTIMIZED = """...
## è¾“å‡ºæ ¼å¼ (JSON)
{
  "key_findings": [
    {
      "statement": "å‘ç°1ï¼šå¤§éƒ¨åˆ†ç”¨æˆ·è®¤ä¸º...",
      "source_ids": [1, 5],  // å¿…é¡»å¼•ç”¨æ”¯æ’‘è¯¥è§‚ç‚¹çš„ç¬”è®°åºå·
      "confidence": "high"
    }
  ],
  "user_pain_points": [
    {
      "point": "ç—›ç‚¹1",
      "severity": "high",
      "source_ids": [2]
    }
  ],
  ...
}
...
"""
```

---

## 2. æµç¨‹æ¶æ„ä¼˜åŒ–ä¸ LLM è°ƒç”¨ç‚¹ (Workflow & LLM Integration)

å½“å‰æ¶æ„ (`orchestrator.py`) æ˜¯çº¿æ€§çš„ï¼š`Planner -> Searcher (Loop) -> Analyzer`ã€‚å¯ä»¥å¼•å…¥æ›´çµæ´»çš„ Agent èŠ‚ç‚¹ã€‚

### 2.1 å¼•å…¥ "Keyword Refiner" (å…³é”®è¯ä¼˜åŒ–èŠ‚ç‚¹)
**ç°çŠ¶**: Planner ç”Ÿæˆå…³é”®è¯åï¼ŒSearcher ç›´æ¥æœç´¢ã€‚å¦‚æœå…³é”®è¯æ˜¯"ä¸Šæµ· æ—…æ¸¸ ç»ç»å­"ï¼Œå¯èƒ½æœå‡ºä¸€å †åƒåœ¾ã€‚
**ä¼˜åŒ–**: åœ¨ Planner å’Œ Searcher ä¹‹é—´å¢åŠ ä¸€ä¸ªè½»é‡çº§ LLM æ£€æŸ¥ç‚¹ã€‚

**ä»£ç é€»è¾‘ç¤ºä¾‹**:
```python
# ä¼ªä»£ç é€»è¾‘
async def refine_keywords(keywords, task):
    # ç¬¬ä¸€æ­¥ï¼šLLM é¢„åˆ¤
    check_prompt = f"é’ˆå¯¹ä»»åŠ¡'{task}'ï¼Œä»¥ä¸‹å…³é”®è¯'{keywords}'æ˜¯å¦è¿‡äºå®½æ³›æˆ–å®¹æ˜“æœå‡ºå¹¿å‘Šï¼Ÿå¦‚æœæ˜¯ï¼Œè¯·ä¿®æ”¹ã€‚"
    refined = await llm.invoke(check_prompt)
    
    # ç¬¬äºŒæ­¥ (å¯é€‰)ï¼šè¯•æœç´¢
    # éšæœºå– 1 ä¸ªè¯æœç´¢ 3 æ¡ï¼Œçœ‹çœ‹ç»“æœè´¨é‡ï¼Œå¦‚æœå…¨æ˜¯å¹¿å‘Šï¼Œè‡ªåŠ¨ä¸¢å¼ƒè¯¥è¯ã€‚
    return refined
```

### 2.2 æœç´¢è¿‡ç¨‹çš„å¹¶è¡ŒåŒ– (Parallel Search)
**ç°çŠ¶**: `SearcherAgent.run` ä¸­ä½¿ç”¨ `for i, keyword in enumerate(keywords)` ä¸²è¡Œæœç´¢ã€‚
**ä¼˜åŒ–**: ç½‘ç»œ IO æ˜¯ç“¶é¢ˆï¼Œåº”è¯¥å¹¶è¡ŒåŒ–ã€‚

**ä»£ç é€»è¾‘ç¤ºä¾‹ (Standard Python)**:
```python
# rednote_research/agents/searcher.py

async def run(self, state, on_log):
    # ...
    tasks = []
    for keyword in keywords_to_search:
        tasks.append(self._search_single_keyword(keyword, state, on_log))
    
    # å¹¶å‘æ‰§è¡Œæ‰€æœ‰æœç´¢
    results = await asyncio.gather(*tasks)
    
    # ç»“æœåˆå¹¶ä¸å»é‡
    for res in results:
        all_notes.extend(res)
    # ...
```

### 2.3 å¢åŠ  "Reviewer" (å®¡æ ¸èŠ‚ç‚¹)
**ç°çŠ¶**: Analyzer è‡ªæˆ‘åæ€ (`needs_more_data`)ã€‚
**ä¼˜åŒ–**: å¢åŠ ç‹¬ç«‹ Reviewer æ­¥éª¤ï¼Œåœ¨æœ€ç»ˆ output ä¹‹å‰ï¼Œæ£€æŸ¥æŠ¥å‘Šæ˜¯å¦"å¹»è§‰"ï¼Œæ˜¯å¦çœŸçš„è§£å†³ç”¨æˆ·é—®é¢˜ã€‚

**æç¤ºè¯ç¤ºä¾‹**:
```python
REVIEWER_PROMPT = """ä½ æ˜¯ä¸€ä¸ªä¸¥è‹›çš„ä¸»ç¼–ã€‚è¯·æ£€æŸ¥ä»¥ä¸‹åˆ†ææŠ¥å‘Šæ˜¯å¦æ»¡è¶³ï¼š
1. **çœŸå®æ€§**ï¼šæ‰€æœ‰ç»“è®ºæ˜¯å¦æœ‰æ•°æ®æ”¯æ’‘ï¼Ÿ
2. **å®Œæ•´æ€§**ï¼šæ˜¯å¦é—æ¼äº†ç”¨æˆ·çš„æŸä¸ªçº¦æŸæ¡ä»¶ï¼Ÿ
3. **å¯è¯»æ€§**ï¼šæ˜¯å¦å­˜åœ¨ç”±äºæœºå™¨ç”Ÿæˆå¯¼è‡´çš„ç”Ÿç¡¬è¡¨è¾¾ï¼Ÿ

å¦‚æœä¸æ»¡è¶³ï¼Œè¯·ç»™å‡ºä¿®æ”¹æ„è§ï¼Œå‘å› ANALYZER é‡å†™ã€‚
"""
```

### 2.4 åŠ¨æ€è¿­ä»£ (Iterative Research)
**ç°çŠ¶**: `state.iteration_count` ä»…ä»…æ˜¯è¡¥å……å…³é”®è¯ã€‚
**ä¼˜åŒ–**: çœŸæ­£çš„è¿­ä»£åº”è¯¥å…è®¸"ä¿®æ”¹æ–¹å‘"ã€‚å¦‚æœç¬¬ä¸€è½®æœç´¢å‘ç°"æ­¤æ—¶å»ä¸Šæµ·ä¸åˆé€‚"ï¼ŒAgent åº”è¯¥ä¸»åŠ¨å»ºè®®ä¿®æ”¹é¢˜ç›®ä¸º"ä¸Šæµ·å‘¨è¾¹æ¸¸"ã€‚

---

## 3. è½åœ°å»ºè®® (Action Plan)

1.  **P0 (é«˜ä¼˜å…ˆçº§)**: ä¿®æ”¹ `planner.py` å¢åŠ  CoT (Reasoning)ï¼Œè¿™èƒ½ä»¥æœ€ä½æˆæœ¬æå‡åç»­æ‰€æœ‰æ­¥éª¤çš„è´¨é‡ã€‚
2.  **P1 (ä¸­ä¼˜å…ˆçº§)**: ä¿®æ”¹ `searcher.py` å®ç° `asyncio.gather` å¹¶è¡Œæœç´¢ï¼Œæ˜¾è‘—æå‡ç”¨æˆ·ä½“éªŒï¼ˆé€Ÿåº¦ï¼‰ã€‚
3.  **P2 (ä¸­ä¼˜å…ˆçº§)**: ä¼˜åŒ– `analyzer.py` çš„ Citation æœºåˆ¶ï¼Œè®©ç”Ÿæˆçš„æŠ¥å‘Šæ›´å¯ä¿¡ã€‚

è¯¥åˆ†æåŸºäºå½“å‰ `rednote_research` ç›®å½•ä¸‹çš„ä»£ç å¿«ç…§ã€‚
